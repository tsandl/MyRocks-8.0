--echo # Bug#22601255 Restoring a dump of binary column, made with mysqldump, warns of invalid string

CREATE TABLE t1(
u CHAR(10),
b BINARY(16),
blo BLOB,
g GEOMETRY,
bi BIT(64));

# These bytes are not valid utf8, except for the first column.
INSERT INTO t1 VALUES(
'basic',
x'EE0C6D03C34C11E5B1640026B977EB17',
x'EE0C6D03C34C11E5B1640026B977EB17',
ST_GeomFromText('POINT(1 1)'),
x'EE0C6D03C34C11E5');

SELECT
u='basic',
HEX(b)='EE0C6D03C34C11E5B1640026B977EB17',
HEX(blo)='EE0C6D03C34C11E5B1640026B977EB17',
HEX(g)='000000000101000000000000000000F03F000000000000F03F',
HEX(bi)='EE0C6D03C34C11E5',
ST_AsText(g) FROM t1;

# Before fix you would see
# Warning (Code 1300): Invalid utf8mb4 character string: 'EE0C6D'
# Warning (Code 1300): Invalid utf8mb4 character string: 'F03F00'

--exec $MYSQL_DUMP --skip-comments test > $MYSQLTEST_VARDIR/tmp/bug22601255.sql
DROP TABLE t1;
--exec $MYSQL --show-warnings test < $MYSQLTEST_VARDIR/tmp/bug22601255.sql

SHOW CREATE TABLE t1;
SELECT
u='basic',
HEX(b)='EE0C6D03C34C11E5B1640026B977EB17',
HEX(blo)='EE0C6D03C34C11E5B1640026B977EB17',
HEX(g)='000000000101000000000000000000F03F000000000000F03F',
HEX(bi)='EE0C6D03C34C11E5',
ST_AsText(g) FROM t1;

# non-extended INSERT had same problem; it has different code path

--exec $MYSQL_DUMP --skip-extended-insert --skip-comments test > $MYSQLTEST_VARDIR/tmp/bug22601255.sql
DROP TABLE t1;
--exec $MYSQL --show-warnings test < $MYSQLTEST_VARDIR/tmp/bug22601255.sql

SHOW CREATE TABLE t1;
SELECT
u='basic',
HEX(b)='EE0C6D03C34C11E5B1640026B977EB17',
HEX(blo)='EE0C6D03C34C11E5B1640026B977EB17',
HEX(g)='000000000101000000000000000000F03F000000000000F03F',
HEX(bi)='EE0C6D03C34C11E5',
ST_AsText(g) FROM t1;

# Same test with mysqlPUMP

--exec $MYSQL_PUMP --include-databases test > $MYSQLTEST_VARDIR/tmp/bug22601255.sql
DROP TABLE t1;
--exec $MYSQL --show-warnings test < $MYSQLTEST_VARDIR/tmp/bug22601255.sql

SHOW CREATE TABLE t1;
SELECT
u='basic',
HEX(b)='EE0C6D03C34C11E5B1640026B977EB17',
HEX(blo)='EE0C6D03C34C11E5B1640026B977EB17',
HEX(g)='000000000101000000000000000000F03F000000000000F03F',
HEX(bi)='EE0C6D03C34C11E5',
ST_AsText(g) FROM t1;

DROP TABLE t1;
--remove_file $MYSQLTEST_VARDIR/tmp/bug22601255.sql

# Verify mysqldump's memory buffer accounts for "_binary " properly
CREATE TABLE t1 (pk INT, v1 VARCHAR(255), v2 VARCHAR(255), v3 VARCHAR(255), v4 VARCHAR(128), v5 VARCHAR(64), v6 VARCHAR(16), v7 VARCHAR(16), v8 VARCHAR (8), v9 VARBINARY(32), v10 VARBINARY(32));
SELECT '12345678901234567890123456789012345678901234567890' INTO @s;
SELECT CONCAT(@s, @s, @s, @s, @s) INTO @s1;
INSERT INTO t1 VALUES (1, @s1, @s1, @s1, SUBSTRING(@s1, 1, 128), SUBSTRING(@s1, 1, 64), SUBSTRING(@s1, 1, 16), SUBSTRING(@s1, 1, 16), SUBSTRING(@s1, 1, 8), '', 'NULL');
CHECKSUM TABLE t1;
--exec $MYSQL_DUMP test t1 > $MYSQLTEST_VARDIR/tmp/bug96053.sql
DROP TABLE t1;
--exec $MYSQL test < $MYSQLTEST_VARDIR/tmp/bug96053.sql
CHECKSUM TABLE t1;
DROP TABLE t1;
--remove_file $MYSQLTEST_VARDIR/tmp/bug96053.sql
